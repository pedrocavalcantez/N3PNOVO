{% extends "base.html" %} {% block title %}Painel{% endblock %} {% block content
%}
<div class="container mt-4">
  <h1>Bem-vindo, {{ user.nome }}!</h1>

  <!-- Macronutrients Summary Cards -->
  <div class="row mt-4">
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Calorias</h5>
          <p class="card-text">{{ total_calories|round|int }} kcal</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Proteínas</h5>
          <p class="card-text">{{ total_proteins|round|int }}g</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Carboidratos</h5>
          <p class="card-text">{{ total_carbs|round|int }}g</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Gorduras</h5>
          <p class="card-text">{{ total_fats|round|int }}g</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Food Form -->
  <div class="card mt-4">
    <div class="card-body">
      <h5 class="card-title">Adicionar Alimento</h5>
      <form id="addFoodForm" action="{{ url_for('add_food') }}" method="POST">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="foodSearch">Código do Alimento</label>
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  id="foodSearch"
                  placeholder="Digite o código..."
                  autocomplete="off"
                />
                <input type="hidden" id="food_id" name="food_id" required />
              </div>
              <div
                id="searchResults"
                class="list-group position-absolute"
                style="width: 95%; z-index: 1000; display: none"
              ></div>
            </div>
          </div>
          <div class="col-md-5">
            <div class="form-group">
              <label for="quantity">Quantidade (g)</label>
              <input
                type="number"
                class="form-control"
                id="quantity"
                name="quantity"
                required
                min="0"
                step="0.1"
                value=""
              />
            </div>
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button
              type="button"
              class="btn btn-success"
              id="addMoreFood"
              style="margin-bottom: 2px"
            >
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>

        <!-- Selected Foods List -->
        <div class="mt-3" id="selectedFoodsList" style="display: none">
          <h6>Alimentos Selecionados</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Quantidade</th>
                  <th>Calorias</th>
                  <th>Proteínas</th>
                  <th>Carboidratos</th>
                  <th>Gorduras</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="selectedFoodsTable"></tbody>
            </table>
          </div>
        </div>

        <!-- Nutritional Information Preview -->
        <div class="row mt-3" id="nutritionalInfo" style="display: none">
          <div class="col-md-12">
            <h6>Informação Nutricional (baseada na quantidade)</h6>
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label>Calorias</label>
                  <input
                    type="text"
                    class="form-control-plaintext"
                    id="previewCalorias"
                    readonly
                  />
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label>Proteínas</label>
                  <input
                    type="text"
                    class="form-control-plaintext"
                    id="previewProteinas"
                    readonly
                  />
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label>Carboidratos</label>
                  <input
                    type="text"
                    class="form-control-plaintext"
                    id="previewCarboidratos"
                    readonly
                  />
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label>Gorduras</label>
                  <input
                    type="text"
                    class="form-control-plaintext"
                    id="previewGorduras"
                    readonly
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary mt-3">
          Adicionar Alimentos
        </button>
      </form>
    </div>
  </div>

  <!-- Food List -->
  <div class="card mt-4">
    <div class="card-body">
      <h5 class="card-title">Alimentos Consumidos Hoje</h5>
      {% if foods %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Horário</th>
              <th>Código</th>
              <th>Quantidade</th>
              <th>Calorias</th>
              <th>Proteínas</th>
              <th>Carboidratos</th>
              <th>Gorduras</th>
            </tr>
          </thead>
          <tbody>
            {% for food in foods %}
            <tr>
              <td>{{ food.date.strftime('%H:%M') }}</td>
              <td>{{ food.name }}</td>
              <td>{{ food.quantity }}g</td>
              <td>{{ food.calories|round|int }}</td>
              <td>{{ food.proteins|round|int }}g</td>
              <td>{{ food.carbs|round|int }}g</td>
              <td>{{ food.fats|round|int }}g</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p>Nenhum alimento registrado hoje.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Add Font Awesome for icons -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
/>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("foodSearch");
    const searchResults = document.getElementById("searchResults");
    const foodIdInput = document.getElementById("food_id");
    const quantityInput = document.getElementById("quantity");
    const nutritionalInfo = document.getElementById("nutritionalInfo");
    const addMoreFoodBtn = document.getElementById("addMoreFood");
    const selectedFoodsList = document.getElementById("selectedFoodsList");
    const selectedFoodsTable = document.getElementById("selectedFoodsTable");
    let debounceTimer;
    let selectedFoodData = null;
    let selectedFoods = [];

    // Style the results dropdown
    searchResults.style.maxHeight = "200px";
    searchResults.style.overflowY = "auto";
    searchResults.style.backgroundColor = "white";
    searchResults.style.border = "1px solid #ddd";
    searchResults.style.borderRadius = "4px";
    searchResults.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";

    function updateNutritionalInfo() {
      if (selectedFoodData) {
        const quantity = parseFloat(quantityInput.value) || 0;
        const proportion = quantity / selectedFoodData.Quantidade;

        document.getElementById("previewCalorias").value =
          Math.round(selectedFoodData.Calorias * proportion) + " kcal";
        document.getElementById("previewProteinas").value =
          Math.round(selectedFoodData.Proteínas * proportion) + "g";
        document.getElementById("previewCarboidratos").value =
          Math.round(selectedFoodData.Carboidratos * proportion) + "g";
        document.getElementById("previewGorduras").value =
          Math.round(selectedFoodData.Gorduras * proportion) + "g";

        nutritionalInfo.style.display = "block";
      }
    }

    function addFoodToList() {
      if (!selectedFoodData || !quantityInput.value) {
        alert("Por favor, selecione um alimento e insira a quantidade.");
        return;
      }

      const quantity = parseFloat(quantityInput.value);
      const proportion = quantity / selectedFoodData.Quantidade;

      const foodItem = {
        id: foodIdInput.value,
        code: searchInput.value,
        quantity: quantity,
        calories: Math.round(selectedFoodData.Calorias * proportion),
        proteins: Math.round(selectedFoodData.Proteínas * proportion),
        carbs: Math.round(selectedFoodData.Carboidratos * proportion),
        fats: Math.round(selectedFoodData.Gorduras * proportion),
      };

      selectedFoods.push(foodItem);
      updateSelectedFoodsList();

      // Clear inputs
      searchInput.value = "";
      foodIdInput.value = "";
      quantityInput.value = "";
      selectedFoodData = null;
      nutritionalInfo.style.display = "none";
      searchResults.style.display = "none";
    }

    function updateSelectedFoodsList() {
      if (selectedFoods.length === 0) {
        selectedFoodsList.style.display = "none";
        return;
      }

      selectedFoodsList.style.display = "block";
      selectedFoodsTable.innerHTML = "";

      selectedFoods.forEach((food, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${food.code}</td>
          <td>${food.quantity}g</td>
          <td>${food.calories} kcal</td>
          <td>${food.proteins}g</td>
          <td>${food.carbs}g</td>
          <td>${food.fats}g</td>
          <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeFood(${index})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        selectedFoodsTable.appendChild(row);
      });
    }

    window.removeFood = function (index) {
      selectedFoods.splice(index, 1);
      updateSelectedFoodsList();
    };

    // Add click event listener to the add more food button
    addMoreFoodBtn.addEventListener("click", addFoodToList);

    searchInput.addEventListener("input", function () {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = this.value.trim();
        if (query.length >= 1) {
          fetch(`/search_food?query=${encodeURIComponent(query)}`)
            .then((response) => response.json())
            .then((data) => {
              searchResults.innerHTML = "";
              if (data.length > 0) {
                searchResults.style.display = "block";
                data.forEach((food) => {
                  const item = document.createElement("a");
                  item.href = "#";
                  item.className = "list-group-item list-group-item-action";
                  item.textContent = food.text;
                  item.addEventListener("click", (e) => {
                    e.preventDefault();
                    searchInput.value = food.text;
                    foodIdInput.value = food.id;
                    selectedFoodData = food.nutritionalInfo;
                    quantityInput.value = selectedFoodData.Quantidade;
                    updateNutritionalInfo();
                    searchResults.style.display = "none";
                  });
                  searchResults.appendChild(item);
                });
              } else {
                searchResults.style.display = "none";
              }
            })
            .catch((error) => console.error("Error:", error));
        } else {
          searchResults.style.display = "none";
        }
      }, 300);
    });

    quantityInput.addEventListener("input", updateNutritionalInfo);

    // Hide results when clicking outside
    document.addEventListener("click", function (e) {
      if (
        !searchInput.contains(e.target) &&
        !searchResults.contains(e.target)
      ) {
        searchResults.style.display = "none";
      }
    });

    // Show results when focusing on input if there's text
    searchInput.addEventListener("focus", function () {
      if (this.value.trim().length >= 1) {
        searchResults.style.display = "block";
      }
    });

    // Modify form submission
    document
      .getElementById("addFoodForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        // If there are selected foods, submit them all
        if (selectedFoods.length > 0) {
          const formData = new FormData();
          formData.append("foods", JSON.stringify(selectedFoods));

          fetch("{{ url_for('add_food') }}", {
            method: "POST",
            body: formData,
          }).then((response) => {
            if (response.ok) {
              window.location.reload();
            }
          });
        }
        // If there's only the current food, submit as before
        else if (selectedFoodData && quantityInput.value) {
          this.submit();
        }
      });
  });
</script>
{% endblock %}
